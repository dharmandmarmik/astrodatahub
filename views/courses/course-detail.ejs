<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= course.title %> | Mission Path</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; color: #f8fafc; }
        
        /* The Adventure Path SVG */
        .road-svg { position: absolute; top: 0; left: 50%; transform: translateX(-50%); z-index: 0; pointer-events: none; }
        .path-line { stroke-dasharray: 12; animation: dash-flow 3s linear infinite; }
        @keyframes dash-flow { to { stroke-dashoffset: -24; } }

        /* Floating UI */
        .glass-ui { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .node-active { filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5)); border-color: #3b82f6 !important; }
        .node-complete { filter: drop-shadow(0 0 20px rgba(16, 185, 129, 0.5)); border-color: #10b981 !important; background: #064e3b !important; }
        
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); transition: all 0.3s ease; }
        .btn-primary:hover { box-shadow: 0 0 30px rgba(37, 99, 235, 0.6); transform: translateY(-2px); }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <%- include('../partials/header') %>

    <header class="pt-40 pb-12 px-6 relative z-10">
        <div class="max-w-4xl mx-auto text-center">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/20 mb-8">
                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                <span class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Sector: <%= course.subject %></span>
            </div>
            <h1 class="text-5xl md:text-7xl font-black text-white mb-6 tracking-tighter"><%= course.title %></h1>
            <p class="text-slate-400 font-medium max-w-2xl mx-auto text-lg leading-relaxed"><%- course.description %></p>
        </div>
    </header>

    <main class="relative py-20 min-h-screen">
        
        <svg class="road-svg" width="400" height="<%= (modules.length * 300) + 200 %>" viewBox="0 0 400 <%= (modules.length * 300) + 200 %>" fill="none">
            <path d="M 200 0 
                <% modules.forEach((_, i) => { 
                    let x = (i % 2 === 0) ? 300 : 100;
                    let y = (i + 1) * 300;
                    let prevY = i * 300;
                %>
                C 200 <%= prevY + 150 %>, <%= x %> <%= prevY + 150 %>, <%= x %> <%= y %>
                S 200 <%= y + 150 %>, 200 <%= y + 300 %>
                <% }) %>" 
                stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
            
            <% if (isEnrolled) { %>
            <path class="path-line" d="M 200 0 
                <% modules.forEach((_, i) => { 
                    let x = (i % 2 === 0) ? 300 : 100;
                    let y = (i + 1) * 300;
                    let prevY = i * 300;
                %>
                C 200 <%= prevY + 150 %>, <%= x %> <%= prevY + 150 %>, <%= x %> <%= y %>
                S 200 <%= y + 150 %>, 200 <%= y + 300 %>
                <% }) %>" 
                stroke="#3b82f6" stroke-width="4" stroke-linecap="round"/>
            <% } %>
        </svg>

        <div class="max-w-5xl mx-auto relative z-10">
            <% if (modules && modules.length > 0) { %>
                <% modules.forEach((module, index) => { 
                    const isCompleted = completedModuleIds.includes(module.id);
                    let side = (index % 2 === 0) ? 'flex-row' : 'flex-row-reverse';
                    let textAlign = (index % 2 === 0) ? 'text-left ml-10' : 'text-right mr-10';
                %>
                <div class="flex items-center <%= side %> justify-center mb-56 w-full">
                    
                    <div class="relative group">
                        <div class="w-28 h-28 md:w-36 md:h-36 rounded-[2.5rem] rotate-12 glass-ui border-4 flex items-center justify-center transition-all duration-500
                            <%= isCompleted ? 'node-complete' : (isEnrolled ? 'node-active' : 'opacity-40 border-slate-800') %> group-hover:rotate-0">
                            
                            <div class="-rotate-12 group-hover:rotate-0 transition-transform text-center">
                                <% if (isCompleted) { %>
                                    <span class="text-4xl">‚úÖ</span>
                                <% } else { %>
                                    <span class="text-xs font-black text-blue-400 block uppercase">LVL</span>
                                    <span class="text-4xl md:text-5xl font-black text-white"><%= index + 1 %></span>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <div class="w-[300px] md:w-[450px] <%= textAlign %>">
                        <div class="glass-ui p-8 rounded-[2.5rem] transition-all hover:scale-105 border-l-4 <%= isCompleted ? 'border-l-emerald-500' : (isEnrolled ? 'border-l-blue-500' : 'border-l-transparent') %>">
                            <h3 class="text-2xl font-black text-white mb-2"><%= module.module_title %></h3>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-6">Unit Objective: Research Phase</p>
                            
                            <div class="flex items-center gap-3 <%= (index % 2 === 0) ? 'justify-start' : 'justify-end' %>">
                                <% if (user && isEnrolled) { %>
                                    <a href="/courses/course/<%= course.id %>/module/<%= module.id %>" 
                                       class="px-8 py-3 btn-primary text-white rounded-2xl text-[10px] font-black uppercase tracking-[0.2em]">
                                        <%= isCompleted ? 'Revisit Stage' : 'Start Mission' %>
                                    </a>
                                    <% if (module.quiz) { %>
                                        <a href="/courses/quiz/<%= module.quiz.id %>" class="px-4 py-3 bg-emerald-500/10 text-emerald-400 rounded-2xl border border-emerald-500/20 hover:bg-emerald-500 hover:text-white transition-all">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2"/></svg>
                                        </a>
                                    <% } %>
                                <% } else { %>
                                    <span class="text-xs font-black text-slate-600 uppercase italic">Mission Locked</span>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
                <% }) %>
            <% } %>

            <div class="flex flex-col items-center py-32 text-center">
                <div class="w-40 h-40 bg-amber-500/10 rounded-full border-2 border-dashed border-amber-500 flex items-center justify-center text-7xl mb-8 animate-pulse">
                    üèÜ
                </div>
                <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Final Certification</h2>
                <p class="text-slate-500 font-bold text-xs uppercase mt-2 tracking-widest">Complete all nodes to unlock the scientific credential</p>
            </div>
        </div>
    </main>

    <div class="fixed bottom-10 left-0 right-0 z-[100] px-6">
        <div class="max-w-3xl mx-auto glass-ui rounded-[3rem] p-4 flex items-center justify-between shadow-2xl border-t-2 border-white/10">
            <div class="flex items-center gap-6 ml-6">
                <div>
                    <p class="text-[9px] font-black text-blue-400 uppercase tracking-widest">Learner Progress</p>
                    <p class="text-sm font-black text-white">
                        <%= completedModuleIds.length %> / <%= modules.length %> Nodes
                    </p>
                </div>
                <div class="h-8 w-[2px] bg-slate-800"></div>
                <div>
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Mission Status</p>
                    <p class="text-sm font-black <%= isEnrolled ? 'text-emerald-400' : 'text-slate-400' %>">
                        <%= isEnrolled ? 'ACTIVE' : 'IDLE' %>
                    </p>
                </div>
            </div>

            <div class="flex gap-4">
                <% if (!user) { %>
                    <a href="/auth/login" class="px-10 py-5 bg-white text-slate-950 rounded-[2rem] font-black text-[10px] uppercase tracking-widest">Login to Start</a>
                <% } else if (!isEnrolled) { %>
                    <form action="/courses/enroll/<%= course.id %>" method="POST">
                        <button type="submit" class="px-12 py-5 btn-primary text-white rounded-[2rem] font-black text-[10px] uppercase tracking-[0.2em]">Initialize Path</button>
                    </form>
                <% } else { %>
                    <a href="/dashboard" class="px-10 py-5 bg-slate-800 text-white rounded-[2rem] font-black text-[10px] uppercase tracking-widest hover:bg-slate-700 transition-all">HQ Dashboard</a>
                <% } %>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

</body>
</html>